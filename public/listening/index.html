<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- â¬‡ï¸ CAÅY TWÃ“J CSS BEZ ZMIAN -->
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#0b0e14; color:#eee; }
    .wrap { max-width:960px; margin:0 auto; padding:20px; }
    .player { position:relative; aspect-ratio:16/9; background:#111; border-radius:12px; overflow:hidden; }
    #yt { position:absolute; inset:0; width:100%; height:100%; }
    #scoreBox {
      position:absolute; top:8px; right:12px;
      background:rgba(0,0,0,.6);
      padding:6px 12px; border-radius:8px;
      font-weight:600; font-size:14px; color:#ffd257;
      z-index:10;
    }
    .overlay {
      position:absolute; inset:0; display:none;
      background:rgba(0,0,0,.65);
      align-items:center; justify-content:center;
    }
    .card {
      background:#1b2130;
      border-radius:12px;
      padding:20px;
      max-width:700px;
      width:100%;
    }
    .answer {
      background:#f2f4f8;
      color:#1b2130;
      padding:12px;
      border-radius:10px;
      margin:8px 0;
      cursor:pointer;
    }
    .answer.correct { background:#9fe4cb; }
    .answer.wrong { background:#f1a5a5; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="player">
    <div id="yt"></div>
    <div id="scoreBox">0 / 0</div>

    <div class="overlay" id="overlay">
      <div class="card">
        <div id="instruction"></div>
        <div id="qtext"></div>
        <div id="answers"></div>
        <button id="next">Dalej â–¶</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =====================================================
   PARAMETRY Z URL
===================================================== */
const params = new URLSearchParams(window.location.search);
const MODULE_ID = params.get("module") || "module_1";
const MODE = params.get("mode") || "quiz";

/* =====================================================
   DANE (Å‚adowane z JSON)
===================================================== */
let SEGMENTS = [];
let VIDEO_ID = null;

/* =====================================================
   STAN
===================================================== */
let player;
let current = 0;
let score = 0;
let mcqSelected = false;

/* =====================================================
   ÅADOWANIE DANYCH
===================================================== */
fetch(`/data/content/${MODULE_ID}.listening.${MODE}.json`)
  .then(r => {
    if (!r.ok) throw new Error("Nie znaleziono JSON");
    return r.json();
  })
  .then(data => {
    VIDEO_ID = data.videoId;
    SEGMENTS = data.segments;
    initPlayer();
  })
  .catch(err => {
    console.error("âŒ Listening load error:", err);
    alert("BÅ‚Ä…d Å‚adowania Ä‡wiczenia listening.");
  });

/* =====================================================
   YOUTUBE PLAYER
===================================================== */
function initPlayer() {
  const tag = document.createElement("script");
  tag.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(tag);
}

window.onYouTubeIframeAPIReady = function () {
  player = new YT.Player("yt", {
    videoId: VIDEO_ID,
    playerVars: { rel:0, modestbranding:1, playsinline:1 },
    events: {
      onReady: () => playSegment(0)
    }
  });
};

/* =====================================================
   LOGIKA QUIZU (TAKA JAK BYÅA)
===================================================== */
function playSegment(i) {
  current = i;
  const seg = SEGMENTS[i];

  player.seekTo(seg.start, true);
  player.playVideo();

  const watcher = setInterval(() => {
    if (player.getCurrentTime() >= seg.end) {
      clearInterval(watcher);
      player.pauseVideo();
      showMCQ(seg);
    }
  }, 200);
}

function showMCQ(seg) {
  mcqSelected = false;
  document.getElementById("overlay").style.display = "flex";
  document.getElementById("qtext").textContent = seg.question;

  const box = document.getElementById("answers");
  box.innerHTML = "";

  seg.answers.forEach(a => {
    const div = document.createElement("div");
    div.className = "answer";
    div.textContent = a.text;

    div.onclick = () => {
      if (mcqSelected) return;
      mcqSelected = true;

      if (a.correct) {
        div.classList.add("correct");
        score++;
      } else {
        div.classList.add("wrong");
        [...box.children].forEach(el => {
          if (seg.answers.find(x => x.correct && x.text === el.textContent)) {
            el.classList.add("correct");
          }
        });
      }
      document.getElementById("scoreBox").textContent =
        `${score} / ${SEGMENTS.length}`;
    };

    box.appendChild(div);
  });
}

document.getElementById("next").onclick = () => {
  document.getElementById("overlay").style.display = "none";
  if (current + 1 < SEGMENTS.length) {
    playSegment(current + 1);
  } else {
    alert("ðŸŽ‰ Koniec Ä‡wiczenia");
  }
};
</script>
</body>
</html>
